<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RockBlox 2018</title>

  <style>
    :root{
      --blue:#12a8e0; --black:#000; --green:#21b04a;
      --muted:#6b6b6b; --shadow: rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:Tahoma,Arial,sans-serif; color:#111; user-select:none;
      background: radial-gradient(circle at 20% 10%, #fff 0%, #f7fbff 55%, #fff 100%);
    }
    .frame{
      width:980px; height:640px; margin:14px auto;
      border:7px solid var(--blue); background:#fff;
      box-shadow:0 10px 30px var(--shadow);
      position:relative; overflow:hidden;
    }
    .frame:before{
      content:""; position:absolute; inset:0; pointer-events:none;
      border-top:3px solid #c9f0ff; border-left:3px solid #c9f0ff;
      border-right:3px solid #007aa0; border-bottom:3px solid #007aa0;
      opacity:.9;
    }
    .inner{ padding:18px 22px; height:100%; display:flex; flex-direction:column; gap:10px; }
    .title{
      text-align:center; font-weight:bold; color:#d10000;
      font-size:24px; letter-spacing:.5px; text-shadow:0 1px 0 #fff;
      margin-top:2px;
    }

    .searchRow{
      width:860px; margin:0 auto; height:56px;
      border:5px solid #000; background:#fff;
      display:flex; overflow:hidden; box-shadow:0 4px 0 rgba(0,0,0,.06);
    }
    .searchRow input{ flex:1; border:0; outline:none; font-size:18px; padding:0 18px;
      background:linear-gradient(#fff,#fafafa);
    }
    .searchRow button{
      width:190px; border:0; border-left:5px solid #000;
      font-weight:bold; font-size:18px;
      background:linear-gradient(#f7f7f7,#eaeaea); cursor:pointer;
    }
    .searchRow button:active{ background:linear-gradient(#eaeaea,#f7f7f7); }

    .section{ width:860px; margin:0 auto; display:flex; flex-direction:column; gap:8px; }
    .head{ display:flex; align-items:center; justify-content:space-between; font-weight:bold; padding:0 2px; }
    .head .label{ font-size:20px; letter-spacing:.3px; }
    .right{ display:flex; align-items:center; gap:10px; }
    .tag{ border:2px solid #000; padding:2px 10px; font-size:12px; background:#fff; box-shadow:0 2px 0 rgba(0,0,0,.06); }

    .continueRow{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .emptyBox{
      border:3px dashed #bcbcbc; background:#f9f9f9;
      padding:12px; font-weight:bold; color:#555; text-align:center;
    }

    .tile{
      width:132px; background:#fff; border:2px solid #bdbdbd;
      box-shadow:0 3px 0 rgba(0,0,0,.06); overflow:hidden;
    }
    .tile .thumb{ width:100%; height:92px; background:#f1f1f1; border-bottom:2px solid #d3d3d3; overflow:hidden; }
    .tile .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tile .name{ padding:7px 8px 2px 8px; font-size:12px; font-weight:bold; height:34px; overflow:hidden; }
    .tile .date{ padding:0 8px 6px 8px; font-size:11px; color:var(--muted); font-weight:bold; height:16px; overflow:hidden; }
    .tile button{
      width:100%; border:0; background:linear-gradient(#27bf55,#1aa241);
      color:#fff; font-weight:bold; padding:9px 0; cursor:pointer; font-size:14px;
    }
    .tile button:active{ background:linear-gradient(#1aa241,#27bf55); }

    .listBox{
      width:860px; height:280px; border:5px solid #000; background:#fff;
      overflow:auto; box-shadow:0 6px 0 rgba(0,0,0,.05);
    }
    .gameRow{
      display:flex; align-items:center; gap:14px;
      padding:10px 12px; border-bottom:1px solid #e8e8e8;
      min-height:74px; overflow:hidden;
    }
    .gThumb{ width:62px; height:62px; border:2px solid #d5d5d5; background:#f1f1f1; overflow:hidden; flex:0 0 auto; }
    .gThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .gMain{ width:410px; min-width:410px; overflow:hidden; }
    .gName{
      font-weight:bold; font-size:16px; line-height:18px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin-bottom:6px;
    }
    .metaLine{ display:flex; flex-wrap:wrap; gap:18px; font-weight:bold; font-size:13px; color:#111; }
    .metaLine span{ min-width:108px; white-space:nowrap; display:inline-block; }
    .datePill{
      border:2px solid #000; padding:2px 8px; background:#fff; font-size:12px;
      box-shadow:0 2px 0 rgba(0,0,0,.06); white-space:nowrap; flex:0 0 auto;
    }
    .playBtn{
      margin-left:auto; width:240px; height:50px; border:0;
      background:linear-gradient(#27bf55,#1aa241); color:#fff;
      font-weight:bold; font-size:20px; cursor:pointer; flex:0 0 auto;
    }
    .playBtn:active{ background:linear-gradient(#1aa241,#27bf55); }

    .seg{ display:flex; gap:6px; }
    .segBtn{
      border:2px solid #000; background:#fff; padding:4px 12px;
      cursor:pointer; font-weight:bold; font-size:14px; min-width:44px;
      box-shadow:0 2px 0 rgba(0,0,0,.06);
    }
    .segBtn.active{ background:#000; color:#fff; }
    .loading{ padding:16px; text-align:center; font-weight:bold; }

    .status{
      width:860px; margin:0 auto; display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted); padding-top:2px;
    }
    .btn{
      border:2px solid #000; padding:5px 14px; background:#fff;
      cursor:pointer; font-weight:bold; box-shadow:0 2px 0 rgba(0,0,0,.06);
    }
    .btn:active{ transform:translateY(1px); box-shadow:none; }
  </style>
</head>

<body>
  <div class="frame">
    <div class="inner">
      <div class="title">RockBlox 2018</div>

      <div class="searchRow">
        <input id="searchInput" type="text" value="Search..." />
        <button id="enterBtn">ENTER</button>
      </div>

      <div class="section">
        <div class="head">
          <div class="label">CONTINUE:</div>
          <div class="right"><div class="tag">Local</div></div>
        </div>

        <div id="continueRow" class="continueRow"></div>
        <div id="continueEmpty" class="emptyBox" style="display:none;">
          Brak zapisów. Zagraj w jakąś grę, a pojawi się tutaj (max 4).
        </div>
      </div>

      <div class="section">
        <div class="head">
          <div class="label">GAME:</div>
          <div class="right">
            <span style="font-size:12px;color:#444;font-weight:bold;">Ładowanie:</span>
            <div class="seg">
              <button id="ps5" class="segBtn">5</button>
              <button id="ps10" class="segBtn">10</button>
            </div>
          </div>
        </div>

        <div id="listBox" class="listBox"></div>
      </div>

      <div class="status">
        <div id="statusLeft">Ready</div>
        <button id="refreshBtn" class="btn">Refresh</button>
        <div id="statusRight"></div>
      </div>
    </div>
  </div>

<script>
/* ======= NAJWAŻNIEJSZA POPRAWKA =======
   Czytamy games.json z TEJ SAMEJ STRONY (GitHub Pages),
   więc zero CORS/RAW problemów:
*/
const GAMES_URL = "./games.json";

const CONTINUE_LIMIT = 4;
const MIN_LOADING_MS = 450;

const LS_RECENT = "rb2018_recent";
const LS_LASTSEARCH = "rb2018_lastsearch";
const LS_PAGESIZE = "rb2018_pagesize";

let pageSize = 5;
let allGames = [];
let filteredGames = [];
let renderedCount = 0;
let loading = false;

const $ = (id) => document.getElementById(id);

function setStatus(left, right){
  $("statusLeft").innerText = left || "";
  $("statusRight").innerText = right || "";
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function safeText(x, fallback=""){
  if(x === null || x === undefined) return fallback;
  return String(x);
}

function prettyDate(d){
  const s = (d || "").toString().trim();
  if(!s) return "";
  if(/^\d{4}$/.test(s)) return s;
  return s; // np. "2018-06-12"
}

/* ===== CONTINUE ===== */
function readRecent(){
  try{
    const x = JSON.parse(localStorage.getItem(LS_RECENT) || "[]");
    return Array.isArray(x) ? x : [];
  }catch{ return []; }
}

function writeRecent(arr){
  localStorage.setItem(LS_RECENT, JSON.stringify(arr));
}

function addToRecent(game){
  let rec = readRecent();
  rec = rec.filter(x => String(x.gameId) !== String(game.gameId));
  rec.unshift({
    gameId: String(game.gameId),
    name: game.name || "Nazwa",
    placeId: String(game.placeId),
    iconUrl: game.iconUrl || "",
    date: game.date || ""
  });
  rec = rec.slice(0, CONTINUE_LIMIT);
  writeRecent(rec);
  renderContinue();
}

function renderContinue(){
  const row = $("continueRow");
  const empty = $("continueEmpty");
  row.innerHTML = "";

  const rec = readRecent().filter(x => x && x.gameId && x.placeId);

  if(rec.length === 0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  rec.slice(0, CONTINUE_LIMIT).forEach(item => row.appendChild(makeTile(item)));
}

function makeTile(item){
  const d = document.createElement("div");
  d.className = "tile";

  const th = document.createElement("div");
  th.className = "thumb";
  if(item.iconUrl){
    const img = document.createElement("img");
    img.src = item.iconUrl;
    img.alt = "";
    img.onerror = () => { th.innerHTML = ""; };
    th.appendChild(img);
  }
  d.appendChild(th);

  const nm = document.createElement("div");
  nm.className = "name";
  nm.textContent = item.name || "Nazwa";
  d.appendChild(nm);

  const dt = document.createElement("div");
  dt.className = "date";
  dt.textContent = prettyDate(item.date);
  d.appendChild(dt);

  const btn = document.createElement("button");
  btn.textContent = "Play";
  btn.onclick = () => playGame(item);
  d.appendChild(btn);

  return d;
}

/* ===== PLAY ===== */
function playGame(game){
  const full = allGames.find(g => String(g.gameId) === String(game.gameId)) || game;
  addToRecent(full);
  window.location.href = `roblox://placeId=${encodeURIComponent(full.placeId)}`;
}

/* ===== PAGE SIZE ===== */
function setPageSizeUI(n){
  $("ps5").classList.toggle("active", n === 5);
  $("ps10").classList.toggle("active", n === 10);
}
function setPageSize(n){
  pageSize = (n === 10) ? 10 : 5;
  localStorage.setItem(LS_PAGESIZE, String(pageSize));
  setPageSizeUI(pageSize);
  clearList();
  renderNextPage();
}

/* ===== LOAD GAMES ===== */
async function loadGames(){
  setStatus("Pobieram listę gier...", "");

  const res = await fetch(GAMES_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("Nie mogę pobrać games.json (sprawdź czy jest obok index.html na Pages)");
  const arr = await res.json();
  if(!Array.isArray(arr)) throw new Error("games.json musi być tablicą obiektów");

  allGames = arr
    .filter(x => x && x.gameId != null && x.placeId != null)
    .map(x => ({
      gameId: safeText(x.gameId),
      name: safeText(x.name, "Nazwa"),
      placeId: safeText(x.placeId),
      iconUrl: safeText(x.iconUrl, ""),
      date: safeText(x.date, "")
    }));

  const savedPS = parseInt(localStorage.getItem(LS_PAGESIZE) || "5", 10);
  pageSize = (savedPS === 10) ? 10 : 5;
  setPageSizeUI(pageSize);

  const last = (localStorage.getItem(LS_LASTSEARCH) || "").trim();
  $("searchInput").value = last ? last : "Search...";

  applySearch(last);
  clearList();
  await renderNextPage();

  renderContinue();
}

function clearList(){
  $("listBox").innerHTML = "";
  renderedCount = 0;
}

function applySearch(qRaw){
  const q = (qRaw || "").trim().toLowerCase();
  localStorage.setItem(LS_LASTSEARCH, qRaw || "");

  if(!q || q === "search..."){
    filteredGames = allGames.slice();
  }else{
    filteredGames = allGames.filter(g => (g.name || "").toLowerCase().includes(q));
  }

  clearList();
  setStatus(`Wyniki: ${filteredGames.length}`, "Pages: games.json lokalnie");
}

/* ===== LAZY LOAD ===== */
async function renderNextPage(){
  if(loading) return;
  if(renderedCount >= filteredGames.length) return;

  loading = true;
  const box = $("listBox");

  const loadingDiv = document.createElement("div");
  loadingDiv.className = "loading";
  loadingDiv.textContent = "Loading...";
  box.appendChild(loadingDiv);

  const start = Date.now();
  const slice = filteredGames.slice(renderedCount, renderedCount + pageSize);
  const elapsed = Date.now() - start;
  if(elapsed < MIN_LOADING_MS) await sleep(MIN_LOADING_MS - elapsed);

  box.removeChild(loadingDiv);

  for(const g of slice){
    box.appendChild(makeGameRow(g));
  }

  renderedCount += slice.length;
  loading = false;

  setStatus(
    `Gry: ${filteredGames.length} | Pokazano: ${renderedCount} | Strona: ${pageSize}`,
    "Scroll ładuje kolejne"
  );
}

function makeGameRow(g){
  const row = document.createElement("div");
  row.className = "gameRow";

  const th = document.createElement("div");
  th.className = "gThumb";
  if(g.iconUrl){
    const img = document.createElement("img");
    img.src = g.iconUrl;
    img.alt = "";
    img.onerror = () => { th.innerHTML = ""; };
    th.appendChild(img);
  }
  row.appendChild(th);

  const main = document.createElement("div");
  main.className = "gMain";

  const nm = document.createElement("div");
  nm.className = "gName";
  nm.textContent = g.name || "Nazwa";
  main.appendChild(nm);

  const meta = document.createElement("div");
  meta.className = "metaLine";
  meta.innerHTML = `<span>Visit: —</span><span>Like: —</span><span>Online: —</span>`;
  main.appendChild(meta);

  row.appendChild(main);

  const date = document.createElement("div");
  date.className = "datePill";
  date.textContent = prettyDate(g.date) || "—";
  row.appendChild(date);

  const btn = document.createElement("button");
  btn.className = "playBtn";
  btn.textContent = "Play";
  btn.onclick = () => playGame(g);
  row.appendChild(btn);

  return row;
}

/* ===== EVENTS ===== */
function initEvents(){
  const inp = $("searchInput");
  inp.addEventListener("focus", () => { if(inp.value === "Search...") inp.value = ""; });
  inp.addEventListener("blur", () => { if(!inp.value.trim()) inp.value = "Search..."; });

  $("enterBtn").onclick = () => {
    const q = (inp.value === "Search...") ? "" : inp.value;
    applySearch(q);
    renderNextPage();
  };

  $("refreshBtn").onclick = async () => {
    await loadGames();
  };

  $("ps5").onclick = () => setPageSize(5);
  $("ps10").onclick = () => setPageSize(10);

  $("listBox").addEventListener("scroll", () => {
    const box = $("listBox");
    const nearBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 20;
    if(nearBottom) renderNextPage();
  });
}

/* ===== START ===== */
(async function start(){
  try{
    initEvents();
    renderContinue();
    await loadGames();
  }catch(e){
    setStatus("Błąd startu", e?.message ? String(e.message) : String(e));

    // ====== POPRAWKA: jak jest błąd, to czyścimy Continue i pokazujemy tylko empty ======
    $("continueRow").innerHTML = "";
    $("continueEmpty").style.display = "block";

    $("listBox").innerHTML =
      `<div class="loading">
        Nie mogę pobrać listy gier.<br/><br/>
        Upewnij się, że masz <b>games.json</b> w tym samym folderze co <b>index.html</b> na GitHub Pages.
      </div>`;
  }
})();
</script>
</body>
</html>
